/**
 * LBS Eraser
 * Date: 2015-12-8
 **/
!function(t,i){"use strict";var n={on:function(t,i,n){if("string"==typeof i)return t.addEventListener(i,n,!1);for(var e=0,s=i.length;s>e;e++)t.addEventListener(i[e],n,!1)},off:function(t,i,n){if("string"==typeof i)return t.removeEventListener(i,n,!1);for(var e=0,s=i.length;s>e;e++)t.removeEventListener(i[e],n,!1)}},e=function(t){if(t=t||{},"undefined"==typeof t.canvas)throw"canvas元素未正确定义！";this.canvas="string"==typeof t.canvas?i.querySelector(t.canvas):t.canvas,this.context=this.canvas.getContext("2d"),this.color=t.color||"#bbb",this.size=t.size||16,this.ratio=t.ratio||.5,this.complate=t.complate||function(){}};e.prototype={_init:function(){this._rect()._size()._mask()._bind()},_rect:function(){return this.rect=this.canvas.getBoundingClientRect(),this},_size:function(){return this.canvas.width=this.rect.width,this.canvas.height=this.rect.height,this},_bind:function(){var i=this;n.on(this.canvas,["touchstart","mousedown"],this.startEvent=function(){i._start()}),n.on(this.canvas,["touchmove","mousemove"],this.moveEvent=function(t){i._move(t)}),n.on(this.canvas,["touchend","mouseup"],this.endEvent=function(){i._end()}),n.on(t,["scroll","resize","orientationchange"],this.updateEvent=function(t){i._update(t)})},_unbind:function(){n.off(this.canvas,["touchstart","mousedown"],this.startEvent),n.off(this.canvas,["touchmove","mousemove"],this.moveEvent),n.off(this.canvas,["touchend","mouseup"],this.endEvent),n.off(t,["scroll","resize","orientationchange"],this.updateEvent)},_start:function(){this.moving=!0},_move:function(t){if(this.moving){t.preventDefault();var i=t.touches?t.touches[0]:t,n=i.clientX-this.rect.left,e=i.clientY-this.rect.top;this._draw(n,e)}},_end:function(){this.moving=!1,this._check()},_check:function(){for(var t=this.context.getImageData(0,0,this.canvas.width,this.canvas.height).data,i=t.length,n=i/4,e=0,s=3;i>s;s+=4)0==t[s]&&e++;e>=Math.floor(n*this.ratio)&&(this._clear()._unbind(),this.complate&&this.complate(this.canvas))},_update:function(t){var i=this;this.timer&&clearTimeout(this.timer),this.timer=setTimeout(function(){i._rect(),"scroll"!=t.type&&i._copy()._size()._paste()},100)},_copy:function(){return this._imgData=this.context.getImageData(0,0,this.canvas.width,this.canvas.height),this._canvas=this.canvas.cloneNode(),this._context=this._canvas.getContext("2d"),this._context.putImageData(this._imgData,0,0),this},_paste:function(){return this.context.drawImage(this._canvas,0,0,this.canvas.width,this.canvas.height),this},_mask:function(){return this.context.fillStyle=this.color,this.context.fillRect(0,0,this.canvas.width,this.canvas.height),this},_draw:function(t,i){this.context.save(),this.context.globalCompositeOperation="destination-out",this.context.beginPath(),this.context.arc(t,i,this.size,0,2*Math.PI),this.context.fill(),this.context.restore()},_clear:function(){return this.context.clearRect(0,0,this.canvas.width,this.canvas.height),this},start:function(){this._init()},reset:function(){this.start()}},"function"==typeof define&&(define.amd||define.cmd)?define("Eraser",[],function(){return e}):t.Eraser=e}(window,document);